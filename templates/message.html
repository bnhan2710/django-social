{% extends "base.html" %}
{% load static %}

{% block content %}
<main>
    <style>
        main {
            margin-top: 80px;
        }

        .message-container {
            max-width: 1000px;
            margin: auto;
        }

        img {
            max-width: 100%;
        }

        .inbox_people {
            background: #f8f8f8 none repeat scroll 0 0;
            float: left;
            overflow: hidden;
            width: 40%;
            border-right: 1px solid #c4c4c4;
        }

        .inbox_msg {
            margin-right: 20px;
            border: 1px solid #c4c4c4;
            clear: both;
            overflow: hidden;
        }

        .top_spac {
            margin: 20px 0 0;
        }

        .recent_heading {
            float: left;
            width: 40%;
        }

        .srch_bar {
            display: inline-block;
            text-align: right;
            width: 60%;
        }

        .headind_srch {
            padding: 10px 29px 10px 20px;
            overflow: hidden;
            border-bottom: 1px solid #c4c4c4;
        }

        .recent_heading h4 {
            color: #05728f;
            font-size: 21px;
            margin: auto;
        }

        .srch_bar input {
            border: 1px solid #cdcdcd;
            border-width: 0 0 1px 0;
            width: 100%;
            padding: 2px 0 4px 6px;
            background: none;
        }

        .srch_bar .input-group-addon button {
            background: rgba(0, 0, 0, 0) none repeat scroll 0 0;
            border: medium none;
            padding: 0;
            color: #707070;
            font-size: 18px;
        }

        .srch_bar .input-group-addon {
            margin: 0 0 0 -27px;
        }

        .chat_ib h5 {
            font-size: 15px;
            color: #464646;
            margin: 0 0 8px 0;
        }

        .chat_ib h5 span {
            font-size: 13px;
            float: right;
        }

        .chat_ib p {
            font-size: 14px;
            color: #989898;
            margin: auto;
            text-overflow: ellipsis;
            overflow: hidden;
            white-space: nowrap;
            max-width: 90%;
        }

        .chat_img {
            float: left;
            width: 11%;
        }

        .chat_ib {
            float: left;
            padding: 0 0 0 15px;
            width: 88%;
        }

        .chat_people {
            overflow: hidden;
            clear: both;
        }

        .chat_list {
            border-bottom: 1px solid #c4c4c4;
            margin: 0;
            padding: 18px 16px 10px;
            cursor: pointer;
        }

        .chat_list:hover {
            background: #f1f1f1;
        }

        .inbox_chat {
            height: 550px;
            overflow-y: scroll;
        }

        .active_chat {
            background: #ebebeb;
        }

        .incoming_msg_img {
            display: inline-block;
            width: 6%;
        }

        .received_msg {
            display: inline-block;
            padding: 0 0 0 10px;
            vertical-align: top;
            width: 92%;
        }

        .received_withd_msg p {
            background: #ebebeb none repeat scroll 0 0;
            border-radius: 3px;
            color: #646464;
            font-size: 14px;
            margin: 0;
            padding: 5px 10px 5px 12px;
            width: 100%;
        }

        .time_date {
            color: #747474;
            display: block;
            font-size: 12px;
            margin: 4px 12px 0;
        }

        .received_withd_msg {
            width: 57%;
        }

        .mesgs {
            float: left;
            padding: 30px 15px 0 25px;
            width: 60%;
            position: relative;
        }

        .sent_msg p {
            background: #05728f none repeat scroll 0 0;
            border-radius: 3px;
            font-size: 14px;
            margin: 0;
            color: #fff;
            padding: 5px 10px 5px 12px;
            width: 100%;
        }

        .outgoing_msg {
            overflow: hidden;
            margin: 26px 0 26px;
        }

        .sent_msg {
            float: right;
            width: 46%;
        }

        .input_msg_write input {
            background: rgba(0, 0, 0, 0) none repeat scroll 0 0;
            border: medium none;
            color: #4c4c4c;
            font-size: 15px;
            min-height: 48px;
            width: 100%;
            padding: 10px;
        }

        .type_msg {
            border-top: 1px solid #c4c4c4;
            position: relative;
            margin-top: 15px;
        }

        .msg_send_btn {
            background: #05728f none repeat scroll 0 0;
            border: medium none;
            border-radius: 50%;
            color: #fff;
            cursor: pointer;
            font-size: 17px;
            height: 33px;
            position: absolute;
            right: 0;
            top: 11px;
            width: 33px;
        }

        .messaging {
            padding: 0 0 50px 0;
        }

        .msg_history {
            height: 480px;
            overflow-y: auto;
            padding-right: 15px;
        }

        .msg_history::-webkit-scrollbar {
            width: 5px;
        }

        .msg_history::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .msg_history::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }

        .msg_history::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .profile_img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }

        .unread_badge {
            background-color: #05728f;
            color: white;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 12px;
            float: right;
            margin-left: 5px;
        }

        .typing_indicator {
            color: #05728f;
            font-style: italic;
            font-size: 12px;
            margin-top: -15px;
            margin-bottom: 15px;
            display: none;
        }

        .msg_status {
            float: right;
            font-size: 10px;
            color: #777;
            margin-top: 3px;
        }

        .msg_status i {
            margin-left: 2px;
        }

        .welcome_msg {
            text-align: center;
            padding: 100px 20px;
            color: #777;
        }

        .welcome_msg h3 {
            margin-bottom: 20px;
            color: #05728f;
        }

        .welcome_msg p {
            margin-bottom: 15px;
        }

        .welcome_img {
            width: 150px;
            margin-bottom: 20px;
            opacity: 0.7;
        }

        .chat_header {
            padding: 10px 0;
            border-bottom: 1px solid #c4c4c4;
            margin-bottom: 15px;
        }

        .chat_header h4 {
            margin: 0;
            display: inline-block;
        }

        .chat_header .online_status {
            display: inline-block;
            margin-left: 10px;
            font-size: 12px;
            color: #4CAF50;
        }

        .chat_options {
            float: right;
        }

        .chat_options button {
            background: none;
            border: none;
            cursor: pointer;
            color: #05728f;
        }

        .emoji_picker {
            position: absolute;
            bottom: 50px;
            right: 0;
            z-index: 100;
            display: none;
        }

        .attachment_preview {
            margin-bottom: 10px;
            text-align: right;
        }

        .attachment_preview img {
            max-height: 100px;
            border-radius: 5px;
        }

        .attachment_btn {
            position: absolute;
            right: 40px;
            top: 11px;
            background: none;
            border: none;
            color: #05728f;
            cursor: pointer;
            font-size: 17px;
        }

        .emoji_btn {
            position: absolute;
            right: 70px;
            top: 11px;
            background: none;
            border: none;
            color: #05728f;
            cursor: pointer;
            font-size: 17px;
        }

        .connection_status {
            text-align: center;
            margin-bottom: 10px;
            padding: 5px;
        }

        .status_connected {
            background-color: #4CAF50;
            color: white;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 12px;
        }

        .status_disconnected {
            background-color: #f44336;
            color: white;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 12px;
        }

        .status_connecting {
            background-color: #ff9800;
            color: white;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 12px;
        }
    </style>

    <div class="message-container">
        <div class="messaging">
            <div class="inbox_msg">
                <div class="inbox_people">
                    <div class="headind_srch">
                        <div class="recent_heading">
                            <h4>Recent</h4>
                        </div>
                        <div class="srch_bar">
                            <div class="stylish-input-group">
                                <input type="text" id="search_contacts" class="search-bar" placeholder="Search">
                                <span class="input-group-addon">
                                    <button type="button">
                                        <i class="fa fa-search" aria-hidden="true"></i>
                                    </button>
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="inbox_chat">
                        {% for thread in threads %}
                        <div class="chat_list {% if request.GET.thread_id|add:'0' == thread.id %}active_chat{% endif %}" 
                             data-thread-id="{{ thread.id }}">
                            <div class="chat_people">
                                <div class="chat_img">
                                    <img src="{{ thread.other_profile.profile_pic.url }}" alt="{{ thread.other_user.username }}" class="profile_img">
                                </div>
                                <div class="chat_ib">
                                    <h5>{{ thread.other_user.username }}
                                        {% if thread.unread_count > 0 %}
                                        <span class="unread_badge">{{ thread.unread_count }}</span>
                                        {% endif %}
                                        <span class="chat_date">{{ thread.last_message_time|date:"M d" }}</span>
                                    </h5>
                                    <p>{{ thread.last_message|truncatechars:30 }}</p>
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <div class="chat_list">
                            <div class="chat_ib">
                                <p>No conversations yet</p>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                <div class="mesgs">
                    {% if request.GET.thread_id %}
                    <div id="chat_container" data-thread-id="{{ request.GET.thread_id }}">
                        <!-- Chat messages will be loaded here -->
                        <div class="chat_header">
                            <h4 id="chat_user">Loading...</h4>
                            <span class="online_status" id="online_status"></span>
                            <div class="chat_options">
                                <button id="refresh_btn" title="Refresh"><i class="fa fa-refresh"></i></button>
                            </div>
                        </div>
                        <div class="connection_status" id="connection_status">
                            <span id="ws_status" class="status_disconnected">
                                <i class="fa fa-circle-o-notch fa-spin"></i> Connecting to chat server...
                            </span>
                        </div>
                        <div class="msg_history" id="msg_history">
                            <!-- Messages will be loaded here -->
                        </div>
                        <div class="typing_indicator" id="typing_indicator">
                            <span>Typing...</span>
                        </div>
                        <div class="type_msg">
                            <div class="input_msg_write">
                                <input type="text" id="message_input" class="write_msg" placeholder="Type a message" />
                                <button class="emoji_btn" type="button"><i class="fa fa-smile-o"></i></button>
                                <button class="attachment_btn" type="button"><i class="fa fa-paperclip"></i></button>
                                <button class="msg_send_btn" type="button"><i class="fa fa-paper-plane"></i></button>
                            </div>
                        </div>
                        <div class="emoji_picker" id="emoji_picker">
                            <!-- Emoji picker will be loaded here -->
                        </div>
                    </div>
                    {% else %}
                    <div class="welcome_msg">
                        <img src="{% static 'images/message.png' %}" alt="Welcome" class="welcome_img">
                        <h3>Welcome to Messages</h3>
                        <p>Select a conversation to start messaging</p>
                        <p>Or start a new conversation from a user's profile</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const threadId = document.getElementById('chat_container')?.dataset.threadId;
            let socket = null;
            let typingTimeout = null;
            
            // Connect to WebSocket
            function connectWebSocket() {
                // Update connection status
                const statusEl = document.getElementById('ws_status');
                if (statusEl) {
                    statusEl.className = 'status_connecting';
                    statusEl.innerHTML = '<i class="fa fa-circle-o-notch fa-spin"></i> Connecting...';
                }
                
                // List of WebSocket URLs to try - prioritize the main messages endpoint
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const host = window.location.host;
                const wsUrls = [
                    `${protocol}//${host}/messages/`,
                    `${protocol}//${host}/ws/messages/`,
                    `${protocol}//${host}/ws/`,
                    `${protocol}//${host}/chat/`
                ];
                
                // Log the WebSocket connection attempts
                console.log('Attempting to connect to WebSockets with the following URLs:', wsUrls);
                
                // Try to connect to each URL in sequence
                tryConnect(wsUrls, 0);
                
                function tryConnect(urls, index) {
                    if (index >= urls.length) {
                        console.error('Failed to connect to any WebSocket endpoint');
                        if (statusEl) {
                            statusEl.className = 'status_disconnected';
                            statusEl.innerHTML = '<i class="fa fa-times-circle"></i> Failed to connect';
                        }
                        // Try again after a delay
                        setTimeout(connectWebSocket, 5000);
                        return;
                    }
                    
                    try {
                        const wsUrl = urls[index];
                        console.log(`Attempting to connect to WebSocket at: ${wsUrl} (attempt ${index + 1}/${urls.length})`);
                        
                        socket = new WebSocket(wsUrl);
                        
                        // Set a timeout to try the next URL if this one fails
                        const connectTimeout = setTimeout(() => {
                            if (socket && socket.readyState !== WebSocket.OPEN) {
                                console.log(`Connection to ${wsUrl} failed, trying next URL`);
                                socket.close();
                                tryConnect(urls, index + 1);
                            }
                        }, 5000); // Increased timeout to 5 seconds
                        
                        // Connection opened
                        socket.addEventListener('open', function(event) {
                            clearTimeout(connectTimeout);
                            console.log(`WebSocket connection established to ${wsUrl}`);
                            if (statusEl) {
                                statusEl.className = 'status_connected';
                                statusEl.innerHTML = '<i class="fa fa-check-circle"></i> Connected';
                                
                                // Hide status after 3 seconds
                                setTimeout(() => {
                                    statusEl.style.display = 'none';
                                }, 3000);
                            }
                        });
                        
                        // Listen for messages
                        socket.addEventListener('message', function(event) {
                            const data = JSON.parse(event.data);
                            console.log('Message from server:', data);
                            
                            if (data.type === 'connection_established') {
                                // If we have a thread ID, join it
                                if (threadId) {
                                    joinThread(threadId);
                                }
                            } else if (data.type === 'thread_joined') {
                                // Display messages
                                displayMessages(data.messages);
                                // Update header with other user info
                                updateChatHeader(data.other_user);
                            } else if (data.type === 'new_message') {
                                // Add new message to chat
                                if (data.thread_id === threadId) {
                                    appendMessage(data.message);
                                    // Mark as read
                                    markThreadRead(threadId);
                                } else {
                                    // Update unread count in sidebar
                                    updateUnreadBadge(data.thread_id);
                                }
                            } else if (data.type === 'typing_indicator') {
                                // Show typing indicator if it's from the other user
                                if (data.thread_id === threadId && data.user_id !== parseInt("{{ request.user.id }}")) {
                                    toggleTypingIndicator(data.is_typing);
                                }
                            } else if (data.type === 'unread_counts') {
                                // Update all unread badges
                                updateAllUnreadBadges(data.counts);
                            }
                        });
                        
                        // Connection closed
                        socket.addEventListener('close', function(event) {
                            clearTimeout(connectTimeout);
                            console.log(`WebSocket connection to ${wsUrl} closed`);
                            if (statusEl) {
                                statusEl.style.display = 'block';
                                statusEl.className = 'status_disconnected';
                                statusEl.innerHTML = '<i class="fa fa-exclamation-circle"></i> Disconnected (reconnecting...)';
                            }
                            
                            // Try to reconnect after a delay
                            setTimeout(connectWebSocket, 3000);
                        });
                        
                        // Connection error
                        socket.addEventListener('error', function(event) {
                            console.error(`WebSocket error on ${wsUrl}:`, event);
                            // Add more detailed error logging
                            console.log('WebSocket error details:', {
                                readyState: socket ? socket.readyState : 'No socket',
                                event: event,
                                location: window.location.href
                            });
                            // Don't immediately try the next URL, let the timeout handle it
                        });
                    } catch (error) {
                        console.error(`Error establishing WebSocket connection to ${urls[index]}:`, error);
                        tryConnect(urls, index + 1);
                    }
                }
            }
            
            // Join a thread
            function joinThread(threadId) {
                if (socket && socket.readyState === WebSocket.OPEN) {
                    socket.send(JSON.stringify({
                        command: 'join_thread',
                        thread_id: threadId
                    }));
                }
            }
            
            // Leave a thread
            function leaveThread(threadId) {
                if (socket && socket.readyState === WebSocket.OPEN) {
                    socket.send(JSON.stringify({
                        command: 'leave_thread',
                        thread_id: threadId
                    }));
                }
            }
            
            // Send a message
            function sendMessage(threadId, message) {
                if (socket && socket.readyState === WebSocket.OPEN) {
                    socket.send(JSON.stringify({
                        command: 'send_message',
                        thread_id: threadId,
                        message: message
                    }));
                    
                    // Clear typing indicator
                    sendTypingStatus(false);
                }
            }
            
            // Mark thread as read
            function markThreadRead(threadId) {
                if (socket && socket.readyState === WebSocket.OPEN) {
                    socket.send(JSON.stringify({
                        command: 'mark_thread_read',
                        thread_id: threadId
                    }));
                    
                    // Update UI to remove unread badge
                    const threadElement = document.querySelector(`.chat_list[data-thread-id="${threadId}"]`);
                    const badge = threadElement?.querySelector('.unread_badge');
                    if (badge) {
                        badge.style.display = 'none';
                    }
                }
            }
            
            // Send typing status
            function sendTypingStatus(isTyping) {
                if (socket && socket.readyState === WebSocket.OPEN && threadId) {
                    socket.send(JSON.stringify({
                        command: 'typing',
                        thread_id: threadId,
                        is_typing: isTyping
                    }));
                }
            }
            
            // Display messages in the chat
            function displayMessages(messages) {
                const msgHistory = document.getElementById('msg_history');
                msgHistory.innerHTML = '';
                
                messages.forEach(message => {
                    const isOutgoing = message.user_id == parseInt("{{ request.user.id }}");
                    const messageHtml = createMessageElement(message, isOutgoing);
                    msgHistory.innerHTML += messageHtml;
                });
                
                // Scroll to bottom
                scrollToBottom();
            }
            
            // Append a new message to the chat
            function appendMessage(message) {
                const msgHistory = document.getElementById('msg_history');
                const isOutgoing = message.user_id == parseInt("{{ request.user.id }}");
                const messageHtml = createMessageElement(message, isOutgoing);
                msgHistory.innerHTML += messageHtml;
                
                // Scroll to bottom
                scrollToBottom();
            }
            
            // Create message HTML element
            function createMessageElement(message, isOutgoing) {
                if (isOutgoing) {
                    return `
                        <div class="outgoing_msg">
                            <div class="sent_msg">
                                <p>${message.message}</p>
                                <span class="time_date">${message.timestamp}
                                    <span class="msg_status">
                                        ${message.is_read ? '<i class="fa fa-check-circle"></i>' : '<i class="fa fa-check"></i>'}
                                    </span>
                                </span>
                            </div>
                        </div>
                    `;
                } else {
                    return `
                        <div class="incoming_msg">
                            <div class="incoming_msg_img">
                                <img src="${message.profile_pic || '{% static "images/blank-profile-picture.png" %}'}" alt="Profile" class="profile_img">
                            </div>
                            <div class="received_msg">
                                <div class="received_withd_msg">
                                    <p>${message.message}</p>
                                    <span class="time_date">${message.timestamp}</span>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }
            
            // Update chat header with user info
            function updateChatHeader(user) {
                document.getElementById('chat_user').textContent = user.username;
            }
            
            // Toggle typing indicator
            function toggleTypingIndicator(isTyping) {
                const indicator = document.getElementById('typing_indicator');
                indicator.style.display = isTyping ? 'block' : 'none';
            }
            
            // Update unread badge for a specific thread
            function updateUnreadBadge(threadId) {
                const threadElement = document.querySelector(`.chat_list[data-thread-id="${threadId}"]`);
                if (!threadElement) return;
                
                let badge = threadElement.querySelector('.unread_badge');
                if (!badge) {
                    // Create new badge
                    const nameElement = threadElement.querySelector('h5');
                    badge = document.createElement('span');
                    badge.className = 'unread_badge';
                    badge.textContent = '1';
                    nameElement.appendChild(badge);
                } else {
                    // Update existing badge
                    const count = parseInt(badge.textContent) + 1;
                    badge.textContent = count;
                    badge.style.display = 'inline';
                }
            }
            
            // Update all unread badges
            function updateAllUnreadBadges(counts) {
                for (const threadId in counts) {
                    const count = counts[threadId];
                    const threadElement = document.querySelector(`.chat_list[data-thread-id="${threadId}"]`);
                    if (!threadElement) continue;
                    
                    let badge = threadElement.querySelector('.unread_badge');
                    if (count > 0) {
                        if (!badge) {
                            // Create new badge
                            const nameElement = threadElement.querySelector('h5');
                            badge = document.createElement('span');
                            badge.className = 'unread_badge';
                            nameElement.appendChild(badge);
                        }
                        badge.textContent = count;
                        badge.style.display = 'inline';
                    } else if (badge) {
                        badge.style.display = 'none';
                    }
                }
            }
            
            // Scroll chat to bottom
            function scrollToBottom() {
                const msgHistory = document.getElementById('msg_history');
                msgHistory.scrollTop = msgHistory.scrollHeight;
            }
            
            // Initialize WebSocket connection
            if (threadId) {
                connectWebSocket();
                
                // Set up message input
                const messageInput = document.getElementById('message_input');
                const sendButton = document.querySelector('.msg_send_btn');
                
                // Send message on button click
                sendButton.addEventListener('click', function() {
                    const message = messageInput.value.trim();
                    if (message) {
                        sendMessage(threadId, message);
                        messageInput.value = '';
                    }
                });
                
                // Send message on Enter key
                messageInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        const message = messageInput.value.trim();
                        if (message) {
                            sendMessage(threadId, message);
                            messageInput.value = '';
                        }
                        e.preventDefault();
                    }
                });
                
                // Handle typing indicator
                messageInput.addEventListener('input', function() {
                    // Send typing status
                    sendTypingStatus(true);
                    
                    // Clear previous timeout
                    if (typingTimeout) {
                        clearTimeout(typingTimeout);
                    }
                    
                    // Set timeout to stop typing indicator
                    typingTimeout = setTimeout(function() {
                        sendTypingStatus(false);
                    }, 2000);
                });
                
                // Mark thread as read when chat is opened
                markThreadRead(threadId);
            }
            
            // Handle thread selection
            document.querySelectorAll('.chat_list').forEach(thread => {
                thread.addEventListener('click', function() {
                    const selectedThreadId = this.dataset.threadId;
                    window.location.href = `/messages/?thread_id=${selectedThreadId}`;
                });
            });
            
            // Handle search
            const searchInput = document.getElementById('search_contacts');
            searchInput.addEventListener('input', function() {
                const query = this.value.toLowerCase();
                document.querySelectorAll('.chat_list').forEach(thread => {
                    const username = thread.querySelector('h5').textContent.toLowerCase();
                    if (username.includes(query)) {
                        thread.style.display = '';
                    } else {
                        thread.style.display = 'none';
                    }
                });
            });
            
            // Handle refresh button
            document.getElementById('refresh_btn')?.addEventListener('click', function() {
                if (threadId) {
                    // Rejoin thread to refresh messages
                    joinThread(threadId);
                }
            });
        });
    </script>
</main>
{% endblock %}
