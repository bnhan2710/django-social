{% extends "base.html" %}
{% load static %}

{% block content %}
<main>
    <style>
        :root {
            --main-color: #1b78c7;
            --accent-color: #ff4d67;
            --light-color: #f8f9fa;
            --dark-color: #333;
            --border-color: #eaeaea;
            --box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        main {
            background-color: #f0f2f5;
            padding: 30px 0;
            font-family: 'Inter', sans-serif;
        }
        
        .container-connections {
            max-width: 800px;
            margin: 0 auto;
            padding: 0 2rem;
        }
        
        .connections-header {
            background-color: white;
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: var(--box-shadow);
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .connections-header h1 {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--dark-color);
            margin: 0;
        }
        
        .connections-header .back-link {
            color: var(--main-color);
            text-decoration: none;
            display: flex;
            align-items: center;
            transition: all 0.3s ease;
        }
        
        .connections-header .back-link:hover {
            color: var(--accent-color);
        }
        
        .connections-header .back-link i {
            margin-right: 5px;
        }
        
        .connections-tabs {
            display: flex;
            background-color: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: var(--box-shadow);
            margin-bottom: 1.5rem;
        }
        
        .connections-tab {
            flex: 1;
            text-align: center;
            padding: 1rem;
            font-weight: 500;
            color: var(--dark-color);
            text-decoration: none;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }
        
        .connections-tab.active {
            color: var(--main-color);
            border-bottom-color: var(--main-color);
            background-color: rgba(27, 120, 199, 0.05);
        }
        
        .connections-tab:hover:not(.active) {
            background-color: rgba(0, 0, 0, 0.03);
        }
        
        .connections-list {
            background-color: white;
            border-radius: 15px;
            box-shadow: var(--box-shadow);
            overflow: hidden;
        }
        
        .connection-item {
            display: flex;
            align-items: center;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }
        
        .connection-item:last-child {
            border-bottom: none;
        }
        
        .connection-item:hover {
            background-color: rgba(0, 0, 0, 0.02);
        }
        
        .connection-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            margin-right: 1rem;
            object-fit: cover;
        }
        
        .connection-info {
            flex: 1;
        }
        
        .connection-username {
            font-weight: 600;
            color: var(--dark-color);
            text-decoration: none;
            transition: all 0.3s ease;
            display: block;
            margin-bottom: 0.25rem;
        }
        
        .connection-username:hover {
            color: var(--main-color);
        }
        
        .connection-fullname {
            color: #666;
            font-size: 0.9rem;
        }
        
        .connection-actions form {
            display: inline;
        }
        
        .btn-follow, .btn-unfollow, .btn-message {
            border: none;
            border-radius: 30px;
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-left: 0.5rem;
        }
        
        .btn-follow {
            background-color: var(--main-color);
            color: white;
        }
        
        .btn-follow:hover {
            background-color: #0d6efd;
        }
        
        .btn-unfollow {
            background-color: #f8f9fa;
            color: #666;
            border: 1px solid #ddd;
        }
        
        .btn-unfollow:hover {
            background-color: #f1f1f1;
            color: #333;
        }
        
        .btn-message {
            background-color: #f8f9fa;
            color: var(--main-color);
            border: 1px solid var(--main-color);
        }
        
        .btn-message:hover {
            background-color: rgba(27, 120, 199, 0.1);
        }
        
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: #999;
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: #ccc;
        }
        
        .empty-state h3 {
            margin-bottom: 0.5rem;
            color: #666;
        }
        
        /* WebSocket Status Indicator */
        .ws-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            display: flex;
            align-items: center;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.16);
            z-index: 1000;
            opacity: 0.9;
            transition: all 0.3s ease;
        }
        
        .ws-status.connected {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .ws-status.disconnected {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .ws-status.connecting {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }
        
        .ws-status i {
            margin-right: 5px;
        }
        
        .ws-status.hidden {
            transform: translateY(100px);
            opacity: 0;
        }
        
        @media screen and (max-width: 768px) {
            .container-connections {
                padding: 0 1rem;
            }
            
            .connection-actions {
                display: flex;
                flex-direction: column;
                align-items: flex-end;
            }
            
            .btn-follow, .btn-unfollow, .btn-message {
                margin-left: 0;
                margin-top: 0.5rem;
                width: 100px;
                text-align: center;
            }
        }
    </style>
    
    <div class="container-connections">
        <div class="connections-header">
            <h1>
                {% if page_type == 'followers' %}
                    People following {{ target_user.username }}
                {% else %}
                    People {{ target_user.username }} follows
                {% endif %}
            </h1>
            <a href="{% url 'profile' target_user.username %}" class="back-link">
                <i class="fas fa-arrow-left"></i> Back to profile
            </a>
        </div>
        
        <div class="connections-tabs">
            <a href="{% url 'followers_list' target_user.username %}" class="connections-tab {% if page_type == 'followers' %}active{% endif %}">
                Followers
            </a>
            <a href="{% url 'following_list' target_user.username %}" class="connections-tab {% if page_type == 'following' %}active{% endif %}">
                Following
            </a>
        </div>
        
        <div class="connections-list">
            {% if page_type == 'followers' %}
                {% if followers_list %}
                    {% for follower in followers_list %}
                        <div class="connection-item">
                            <img src="{{ follower.profile.profile_pic.url }}" alt="{{ follower.user.username }}" class="connection-avatar">
                            <div class="connection-info">
                                <a href="{% url 'profile' follower.user.username %}" class="connection-username">@{{ follower.user.username }}</a>
                                <span class="connection-fullname">{{ follower.profile.bio|truncatechars:30 }}</span>
                            </div>
                            <div class="connection-actions">                                    {% if follower.user.username != request.user.username %}
                                    <a href="{% url 'sendmessage' follower.user.id %}" class="btn-message">
                                        <i class="fas fa-envelope"></i> Message
                                    </a>
                                    <form action="{% url 'follow' %}" method="post" style="display: inline-block;">
                                        {% csrf_token %}
                                        <input type="hidden" value="{{ request.user.username }}" name="follower" />
                                        <input type="hidden" value="{{ follower.user.username }}" name="user" />
                                        {% if follower.is_following %}
                                            <button type="submit" class="btn-unfollow">
                                                <i class="fas fa-user-minus"></i> Unfollow
                                            </button>
                                        {% else %}
                                            <button type="submit" class="btn-follow">
                                                <i class="fas fa-user-plus"></i> Follow
                                            </button>
                                        {% endif %}
                                    </form>
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="empty-state">
                        <i class="fas fa-users"></i>
                        <h3>No followers yet</h3>
                        <p>When people follow {{ target_user.username }}, they'll appear here.</p>
                    </div>
                {% endif %}
            {% else %}
                {% if following_list %}
                    {% for following in following_list %}
                        <div class="connection-item">
                            <img src="{{ following.profile.profile_pic.url }}" alt="{{ following.user.username }}" class="connection-avatar">
                            <div class="connection-info">
                                <a href="{% url 'profile' following.user.username %}" class="connection-username">@{{ following.user.username }}</a>
                                <span class="connection-fullname">{{ following.profile.bio|truncatechars:30 }}</span>
                            </div>
                            <div class="connection-actions">                                    {% if following.user.username != request.user.username %}
                                    <a href="{% url 'sendmessage' following.user.id %}" class="btn-message">
                                        <i class="fas fa-envelope"></i> Message
                                    </a>
                                    <form action="{% url 'follow' %}" method="post" style="display: inline-block;">
                                        {% csrf_token %}
                                        <input type="hidden" value="{{ request.user.username }}" name="follower" />
                                        <input type="hidden" value="{{ following.user.username }}" name="user" />
                                        {% if following.is_following %}
                                            <button type="submit" class="btn-unfollow">
                                                <i class="fas fa-user-minus"></i> Unfollow
                                            </button>
                                        {% else %}
                                            <button type="submit" class="btn-follow">
                                                <i class="fas fa-user-plus"></i> Follow
                                            </button>
                                        {% endif %}
                                    </form>
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="empty-state">
                        <i class="fas fa-user-friends"></i>
                        <h3>Not following anyone yet</h3>
                        <p>When {{ target_user.username }} follows people, they'll appear here.</p>
                    </div>
                {% endif %}
            {% endif %}
        </div>
    </div>
    
    <!-- WebSocket Connection Status -->
    <div id="ws-status" class="ws-status hidden">
        <i class="fas fa-circle"></i> <span id="ws-status-text">Checking connection...</span>
    </div>
</main>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // WebSocket status handling
        const wsStatus = document.getElementById('ws-status');
        const wsStatusText = document.getElementById('ws-status-text');
        
        // Check if we have an active WebSocket on the page
        if (window.messageSocket) {
            updateWebsocketStatus();
        } else {
            wsStatus.classList.add('hidden');
        }
        
        function updateWebsocketStatus() {
            if (window.messageSocket) {
                if (window.messageSocket.readyState === WebSocket.OPEN) {
                    wsStatus.className = 'ws-status connected';
                    wsStatusText.textContent = 'Connected';
                    
                    // Hide after 5 seconds
                    setTimeout(() => {
                        wsStatus.classList.add('hidden');
                    }, 5000);
                } else if (window.messageSocket.readyState === WebSocket.CONNECTING) {
                    wsStatus.className = 'ws-status connecting';
                    wsStatusText.textContent = 'Connecting...';
                } else {
                    wsStatus.className = 'ws-status disconnected';
                    wsStatusText.textContent = 'Disconnected';
                }
            }
        }
        
        // Update status when transitioning between pages
        window.addEventListener('beforeunload', function() {
            if (window.messageSocket && window.messageSocket.readyState === WebSocket.OPEN) {
                wsStatus.className = 'ws-status connecting';
                wsStatusText.textContent = 'Navigating...';
            }
        });
    });
</script>
{% endblock %}